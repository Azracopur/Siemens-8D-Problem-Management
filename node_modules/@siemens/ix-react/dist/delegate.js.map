{"version":3,"file":"delegate.js","sources":["../src/delegate.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2024 Siemens AG\n *\n * SPDX-License-Identifier: MIT\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { FrameworkDelegate, registerFrameworkDelegate } from '@siemens/ix';\nimport ReactDOMClient from 'react-dom/client';\nlet viewInstance = 0;\n\nfunction createViewInstance() {\n  return `ix-react-view-${viewInstance++}`;\n}\n\nconst mountedRootNodes: Record<string, ReactDOMClient.Root> = {};\n\nasync function fallbackRootDom(id: string, view: React.ReactNode) {\n  return new Promise((resolve) => {\n    const rootElement = document.createElement('DIV');\n    rootElement.id = id;\n    rootElement.style.display = 'contents';\n    document.body.appendChild(rootElement);\n\n    const root = ReactDOMClient.createRoot(rootElement);\n    root.render(view);\n\n    mountedRootNodes[id] = root;\n\n    setTimeout(() => {\n      const viewElement = rootElement.children[0];\n      resolve(viewElement);\n    });\n  });\n}\n\nasync function fallbackRemoveViewFromRootDom(view: any) {\n  const parent = view.parentElement;\n  const id = parent.id;\n  if (id in mountedRootNodes) {\n    mountedRootNodes[id].unmount();\n    delete mountedRootNodes[id];\n    parent.remove();\n  }\n}\n\nexport class ReactFrameworkDelegate implements FrameworkDelegate {\n  attachViewToPortal?: (id: string, view: any) => Promise<Element>;\n  removeViewFromPortal?: (id: string) => void;\n\n  resolvePortalInitPromise: (() => void) | undefined;\n  portalInitPromise: Promise<void>;\n  isUsingReactPortal = false;\n\n  constructor() {\n    this.portalInitPromise = new Promise<void>(\n      (resolve) => (this.resolvePortalInitPromise = resolve)\n    );\n  }\n\n  async attachView(view: any): Promise<any> {\n    const id = createViewInstance();\n\n    if (!this.isUsingReactPortal) {\n      return fallbackRootDom(id, view);\n    }\n\n    await this.isPortalReady();\n    if (this.attachViewToPortal) {\n      const refElement = await this.attachViewToPortal(id, view);\n      return refElement;\n    }\n\n    console.error('Portal could not be initialized');\n  }\n\n  async removeView(view: any): Promise<void> {\n    if (!this.removeViewFromPortal) {\n      return fallbackRemoveViewFromRootDom(view);\n    }\n\n    const parent = view.parentElement;\n    const id = parent.getAttribute('data-portal-id');\n\n    this.removeViewFromPortal(id);\n  }\n\n  portalReady() {\n    this.resolvePortalInitPromise?.();\n  }\n\n  private async isPortalReady() {\n    return this.portalInitPromise;\n  }\n}\n\nexport const reactFrameworkDelegate = new ReactFrameworkDelegate();\nregisterFrameworkDelegate(reactFrameworkDelegate);\n"],"names":[],"mappings":";;;AAAA;;;;;;;AAOG;AAGH,IAAI,YAAY,GAAG,CAAC;AAEpB,SAAS,kBAAkB,GAAA;AACzB,IAAA,OAAO,CAAA,cAAA,EAAiB,YAAY,EAAE,CAAA,CAAE;AAC1C;AAEA,MAAM,gBAAgB,GAAwC,EAAE;AAEhE,eAAe,eAAe,CAAC,EAAU,EAAE,IAAqB,EAAA;AAC9D,IAAA,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,KAAI;QAC7B,MAAM,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC;AACjD,QAAA,WAAW,CAAC,EAAE,GAAG,EAAE;AACnB,QAAA,WAAW,CAAC,KAAK,CAAC,OAAO,GAAG,UAAU;AACtC,QAAA,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC;QAEtC,MAAM,IAAI,GAAG,cAAc,CAAC,UAAU,CAAC,WAAW,CAAC;AACnD,QAAA,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC;AAEjB,QAAA,gBAAgB,CAAC,EAAE,CAAC,GAAG,IAAI;QAE3B,UAAU,CAAC,MAAK;YACd,MAAM,WAAW,GAAG,WAAW,CAAC,QAAQ,CAAC,CAAC,CAAC;YAC3C,OAAO,CAAC,WAAW,CAAC;AACtB,QAAA,CAAC,CAAC;AACJ,IAAA,CAAC,CAAC;AACJ;AAEA,eAAe,6BAA6B,CAAC,IAAS,EAAA;AACpD,IAAA,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa;AACjC,IAAA,MAAM,EAAE,GAAG,MAAM,CAAC,EAAE;AACpB,IAAA,IAAI,EAAE,IAAI,gBAAgB,EAAE;AAC1B,QAAA,gBAAgB,CAAC,EAAE,CAAC,CAAC,OAAO,EAAE;AAC9B,QAAA,OAAO,gBAAgB,CAAC,EAAE,CAAC;QAC3B,MAAM,CAAC,MAAM,EAAE;IACjB;AACF;MAEa,sBAAsB,CAAA;AAQjC,IAAA,WAAA,GAAA;QAFA,IAAA,CAAA,kBAAkB,GAAG,KAAK;AAGxB,QAAA,IAAI,CAAC,iBAAiB,GAAG,IAAI,OAAO,CAClC,CAAC,OAAO,MAAM,IAAI,CAAC,wBAAwB,GAAG,OAAO,CAAC,CACvD;IACH;IAEA,MAAM,UAAU,CAAC,IAAS,EAAA;AACxB,QAAA,MAAM,EAAE,GAAG,kBAAkB,EAAE;AAE/B,QAAA,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE;AAC5B,YAAA,OAAO,eAAe,CAAC,EAAE,EAAE,IAAI,CAAC;QAClC;AAEA,QAAA,MAAM,IAAI,CAAC,aAAa,EAAE;AAC1B,QAAA,IAAI,IAAI,CAAC,kBAAkB,EAAE;YAC3B,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,EAAE,EAAE,IAAI,CAAC;AAC1D,YAAA,OAAO,UAAU;QACnB;AAEA,QAAA,OAAO,CAAC,KAAK,CAAC,iCAAiC,CAAC;IAClD;IAEA,MAAM,UAAU,CAAC,IAAS,EAAA;AACxB,QAAA,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE;AAC9B,YAAA,OAAO,6BAA6B,CAAC,IAAI,CAAC;QAC5C;AAEA,QAAA,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa;QACjC,MAAM,EAAE,GAAG,MAAM,CAAC,YAAY,CAAC,gBAAgB,CAAC;AAEhD,QAAA,IAAI,CAAC,oBAAoB,CAAC,EAAE,CAAC;IAC/B;IAEA,WAAW,GAAA;AACT,QAAA,IAAI,CAAC,wBAAwB,IAAI;IACnC;AAEQ,IAAA,MAAM,aAAa,GAAA;QACzB,OAAO,IAAI,CAAC,iBAAiB;IAC/B;AACD;AAEM,MAAM,sBAAsB,GAAG,IAAI,sBAAsB;AAChE,yBAAyB,CAAC,sBAAsB,CAAC;;;;"}